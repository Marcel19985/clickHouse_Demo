CREATE DATABASE IF NOT EXISTS demo;

DROP TABLE IF EXISTS demo.taxi_trips;

CREATE TABLE demo.taxi_trips
(
    VendorID UInt8,
    tpep_pickup_datetime DateTime,
    tpep_dropoff_datetime DateTime,
    passenger_count UInt8,
    trip_distance Float32,
    pickup_longitude Float64,
    pickup_latitude Float64,
    RateCodeID UInt8,
    store_and_fwd_flag LowCardinality(String),
    dropoff_longitude Float64,
    dropoff_latitude Float64,
    payment_type UInt8,
    fare_amount Float32,
    extra Float32,
    mta_tax Float32,
    tip_amount Float32,
    tolls_amount Float32,
    improvement_surcharge Float32,
    total_amount Float32
)
    ENGINE = MergeTree
        ORDER BY (tpep_pickup_datetime, VendorID);

SELECT count() FROM demo.taxi_trips;

SELECT VendorID, RateCodeID, count() AS trips
FROM demo.taxi_trips
GROUP BY VendorID, RateCodeID
ORDER BY trips DESC
LIMIT 10;


#trips pro Tag (großer Scan einfache Ausgabe)
SELECT toDate(tpep_pickup_datetime) AS day,
       count() AS trips
FROM demo.taxi_trips
GROUP BY day
ORDER BY day;

#Umsatz pro Vendor(Sum + Avg)
SELECT VendorID,
       count() AS trips,
       sum(total_amount) AS revenue,
       avg(total_amount) AS avg_total
FROM demo.taxi_trips
GROUP BY VendorID
ORDER BY revenue DESC;

#percentiles von trip_distance "Analytics Query" (hier wird gezeigt
#das Clickhouse stark eingebaute Aggregate für Quantile/Percentiles hat)
SELECT
  quantile(0.50)(trip_distance) AS p50,
  quantile(0.90)(trip_distance) AS p90,
  quantile(0.99)(trip_distance) AS p99
FROM demo.taxi_trips;

